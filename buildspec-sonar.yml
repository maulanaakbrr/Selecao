version: 0.2

phases:
  install:
    commands:
      - echo "‚¨áÔ∏è Installing dependencies for Sonar testing..."
      - npm install
      - curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      - unzip sonar-scanner.zip -d /opt
      - export PATH=$PATH:/opt/sonar-scanner-5.0.1.3006-linux/bin

  pre_build:
    commands:
      - echo "üß™ Running unit tests with coverage..."
      - npm test -- --coverage || echo "‚ö†Ô∏è Tests failed, continuing Sonar scan..."

  build:
    commands:
      - echo "üîç Running SonarCloud analysis..."
      - export SONAR_TOKEN=$(aws secretsmanager get-secret-value --secret-id sonarcloud-token --query SecretString --output text | jq -r .SONAR_TOKEN)
      - sonar-scanner \
          -Dsonar.organization=maulanaakbrr \
          -Dsonar.projectKey=maulanaakbrr_Selecao \
          -Dsonar.sources=. \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=$SONAR_TOKEN \
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
